<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•—è¡€ç—‡æ—©æœŸç›£æ§ç³»çµ± - SMART on FHIR Launch</title>
    <script src="https://cdn.jsdelivr.net/npm/fhirclient@5/build/fhir-client.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Microsoft JhengHei', 'Noto Sans TC', sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex; justify-content: center; align-items: center; 
            height: 100vh; color: white; text-align: center;
        }
        .launch-container {
            background: rgba(255,255,255,0.15); backdrop-filter: blur(20px);
            border-radius: 30px; padding: 60px 50px; box-shadow: 0 25px 80px rgba(0,0,0,0.3);
            max-width: 620px; border: 2px solid rgba(255,255,255,0.2);
            text-align: center;
        }
        .logo { 
            font-size: 48px; font-weight: bold; 
            background: linear-gradient(45deg, #d63384, #ff6b9d); 
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; 
            margin-bottom: 30px;
        }
        h1 { font-size: 32px; margin-bottom: 16px; }
        .subtitle { font-size: 18px; opacity: 0.9; margin-bottom: 20px; }
        .spinner {
            border: 8px solid rgba(255,255,255,0.2);
            border-top: 8px solid #28a745;
            border-radius: 50%;
            width: 80px; height: 80px;
            animation: spin 1.2s linear infinite;
            margin: 0 auto 30px;
        }
        .message { font-size: 18px; margin-bottom: 20px; }
        .small { font-size: 14px; opacity: 0.8; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="launch-container">
        <div class="logo">ğŸš¨ Sepsis Monitor</div>
        <h1>æ•—è¡€ç—‡æ—©æœŸç›£æ§ç³»çµ±</h1>
        <p class="subtitle">SMART on FHIR è‡¨åºŠæ±ºç­–æ”¯æ´æ‡‰ç”¨</p>
        
        <div class="spinner"></div>
        <p class="message">æ­£åœ¨é€£æ¥è¡›ç¦éƒ¨ THAS FHIR ä¼ºæœå™¨ä¸¦é€²è¡Œå®‰å…¨æ€§é©—è­‰...</p>
        <p class="small">è«‹ç¨å€™ï¼Œå‹¿é—œé–‰æˆ–é‡æ–°æ•´ç†é é¢</p>
    </div>

    <script>
        // å¾ URL å–å¾— issï¼ˆEHR æä¾›çš„ FHIR serverï¼‰
        const params = new URLSearchParams(window.location.search);
        const iss = params.get("iss");

        if (!iss) {
            document.body.innerHTML = `
                <div style="color: #f8d7da; background: rgba(220,53,69,0.3); padding: 40px; border-radius: 20px; max-width: 600px; margin: auto;">
                    <h2>âŒ å•Ÿå‹•å¤±æ•—</h2>
                    <p>æœªåµæ¸¬åˆ° EHR å•Ÿå‹•åƒæ•¸ (iss)ã€‚<br>è«‹å¾ç›¸å®¹çš„ EHR ç³»çµ±ï¼ˆå¦‚ THAS æ•´åˆçš„ HISï¼‰é‡æ–°å•Ÿå‹•æ­¤æ‡‰ç”¨ã€‚</p>
                </div>
            `;
        } else {
            // è‡ªå‹•åŸ·è¡Œ SMART authorizeï¼ˆç„¡éœ€æŒ‰éˆ•ï¼‰
            FHIR.oauth2.authorize({
                iss: iss,                          // å¾ URL å–å¾—çš„ FHIR server
                clientId: "your_real_client_id_here",  // â˜… å¿…é ˆæ›¿æ›æˆä½ åœ¨ THAS è¨»å†Šçš„çœŸå¯¦ client_id
                scope: "launch patient/Patient.read patient/Observation.read patient/Observation.write patient/Encounter.read openid profile fhirUser",
                redirectUri: window.location.origin + "/index.html",
                // launch åƒæ•¸æœƒè‡ªå‹•å¾ query string å¸¶å…¥ï¼Œç”± fhir-client.js è™•ç†
            }).catch(err => {
                // å¦‚æœ authorize æ‹‹éŒ¯ï¼ˆä¾‹å¦‚ clientId ç„¡æ•ˆï¼‰
                document.body.innerHTML = `
                    <div style="color: #f8d7da; background: rgba(220,53,69,0.3); padding: 40px; border-radius: 20px; max-width: 600px; margin: auto;">
                        <h2>âŒ æˆæ¬Šå¤±æ•—</h2>
                        <p>${err.message || 'æœªçŸ¥éŒ¯èª¤'}</p>
                        <p>å¯èƒ½åŸå› ï¼šclient_id æœªè¨»å†Šã€redirect_uri ä¸ç¬¦ï¼Œæˆ– scope æ¬Šé™ä¸è¶³ã€‚<br>è«‹è¯çµ¡ç³»çµ±ç®¡ç†å“¡ç¢ºèª THAS è¨»å†Šè³‡è¨Šã€‚</p>
                    </div>
                `;
                console.error("SMART authorize éŒ¯èª¤:", err);
            });
        }
    </script>
</body>
</html>