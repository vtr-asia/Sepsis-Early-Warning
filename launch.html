<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•—è¡€ç—‡æ—©æœŸç›£æ§ç³»çµ± - SMART on FHIR Launch</title>
    <script src="https://cdn.jsdelivr.net/npm/fhirclient@5/build/fhir-client.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Microsoft JhengHei', 'Noto Sans TC', sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex; justify-content: center; align-items: center; 
            height: 100vh; color: white; text-align: center;
        }
        .launch-container {
            background: rgba(255,255,255,0.15); 
            backdrop-filter: blur(20px);
            border-radius: 30px; 
            padding: 60px 50px; 
            box-shadow: 0 25px 80px rgba(0,0,0,0.3);
            max-width: 620px; 
            border: 2px solid rgba(255,255,255,0.2);
        }
        .logo { 
            font-size: 48px; 
            font-weight: bold; 
            background: linear-gradient(45deg, #d63384, #ff6b9d); 
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; 
            margin-bottom: 30px;
        }
        h1 { 
            font-size: 32px; 
            margin-bottom: 16px; 
        }
        .subtitle { 
            font-size: 18px; 
            opacity: 0.9; 
            margin-bottom: 20px; 
        }
        .spinner {
            border: 8px solid rgba(255,255,255,0.2);
            border-top: 8px solid #28a745;
            border-radius: 50%;
            width: 80px; 
            height: 80px;
            animation: spin 1.2s linear infinite;
            margin: 0 auto 30px;
        }
        .message { 
            font-size: 18px; 
            margin-bottom: 20px; 
        }
        .small { 
            font-size: 14px; 
            opacity: 0.8; 
        }
        .error-box {
            background: rgba(220,53,69,0.3);
            border: 1px solid #dc3545;
            border-radius: 20px;
            padding: 30px;
            color: #f8d7da;
            max-width: 600px;
            margin: 30px auto 0;
        }
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
    </style>
</head>
<body>
    <div class="launch-container" id="mainContainer">
        <div class="logo">ğŸš¨ Sepsis Monitor</div>
        <h1>æ•—è¡€ç—‡æ—©æœŸç›£æ§ç³»çµ±</h1>
        <p class="subtitle">SMART on FHIR è‡¨åºŠæ±ºç­–æ”¯æ´æ‡‰ç”¨</p>
        
        <div class="spinner" id="spinner"></div>
        <p class="message" id="message">æ­£åœ¨é€£æ¥è¡›ç¦éƒ¨ THAS FHIR ä¼ºæœå™¨ä¸¦é€²è¡Œå®‰å…¨æ€§é©—è­‰...</p>
        <p class="small">è«‹ç¨å€™ï¼Œå‹¿é—œé–‰æˆ–é‡æ–°æ•´ç†é é¢</p>
    </div>

    <script>
        // å¾ URL å–å¾— iss åƒæ•¸
        const params = new URLSearchParams(window.location.search);
        const iss = params.get("iss");

        if (!iss) {
            // æ²’æœ‰ iss åƒæ•¸ â†’ é¡¯ç¤ºéŒ¯èª¤
            document.getElementById('mainContainer').innerHTML = `
                <div class="error-box">
                    <h2>âŒ å•Ÿå‹•å¤±æ•—</h2>
                    <p>æœªåµæ¸¬åˆ° EHR ä¼ºæœå™¨ä½å€ (iss åƒæ•¸)ã€‚<br>
                    è«‹å¾ THAS æˆ–ç›¸å®¹çš„é†«é™¢è³‡è¨Šç³»çµ±é»æ“Šæ‡‰ç”¨é€£çµå•Ÿå‹•ï¼Œ<br>
                    è€Œä¸æ˜¯ç›´æ¥é–‹å•Ÿæ­¤é é¢æˆ–æ‰‹å‹•è²¼ä¸Š URLã€‚</p>
                </div>
            `;
            return;
        }

        // è‡ªå‹•åŸ·è¡Œ SMART on FHIR æˆæ¬Šæµç¨‹
        FHIR.oauth2.authorize({
            iss: iss,
            clientId: "your_thas_registered_client_id_here",  // â˜… å¿…é ˆæ›¿æ›æˆ THAS å¯¦éš›è¨»å†Šçš„ client_id
            scope: "launch patient/Patient.read patient/Observation.read patient/Observation.write patient/Encounter.read openid profile fhirUser",
            redirectUri: window.location.origin + "/index.html"
        }).catch(err => {
            // æˆæ¬Šå¤±æ•—æ™‚é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
            document.getElementById('spinner').style.display = 'none';
            document.getElementById('message').style.display = 'none';
            document.getElementById('mainContainer').innerHTML += `
                <div class="error-box">
                    <h2>âŒ æˆæ¬Šæµç¨‹å¤±æ•—</h2>
                    <p>${err.message || 'æœªçŸ¥éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨ console'}</p>
                    <p>å¸¸è¦‹åŸå› ï¼š<br>
                    â€¢ client_id æœªåœ¨ THAS è¨»å†Š<br>
                    â€¢ redirect_uri æœªæ­£ç¢ºè¨­å®šï¼ˆæ‡‰ç‚º ${window.location.origin}/index.htmlï¼‰<br>
                    â€¢ ç€è¦½å™¨é˜»æ“‹å½ˆå‡ºè¦–çª—æˆ–ç¬¬ä¸‰æ–¹ cookie<br>
                    â€¢ scope æ¬Šé™ä¸è¶³</p>
                    <p>è«‹ç¢ºèª THAS è¨»å†Šè³‡è¨Šï¼Œæˆ–è¯çµ¡ç³»çµ±ç®¡ç†å“¡ã€‚</p>
                </div>
            `;
            console.error("SMART authorize éŒ¯èª¤:", err);
        });
    </script>
</body>
</html>