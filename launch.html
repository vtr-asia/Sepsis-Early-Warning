<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•—è¡€ç—‡æ—©æœŸç›£æ§ç³»çµ± - SMART on FHIR Launch</title>
    <script src="https://cdn.jsdelivr.net/npm/fhirclient@5/build/fhir-client.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Microsoft JhengHei', 'Noto Sans TC', sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex; justify-content: center; align-items: center; 
            height: 100vh; color: white; text-align: center;
        }
        .launch-container {
            background: rgba(255,255,255,0.15); backdrop-filter: blur(20px);
            border-radius: 30px; padding: 60px 50px; box-shadow: 0 25px 80px rgba(0,0,0,0.3);
            max-width: 620px; border: 2px solid rgba(255,255,255,0.2);
        }
        .logo { 
            font-size: 48px; font-weight: bold; 
            background: linear-gradient(45deg, #d63384, #ff6b9d); 
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; 
            margin-bottom: 30px;
        }
        h1 { font-size: 32px; margin-bottom: 16px; }
        .subtitle { font-size: 18px; opacity: 0.9; margin-bottom: 40px; }
        .launch-btn { 
            background: linear-gradient(45deg, #28a745, #20c997); color: white; 
            border: none; padding: 20px 60px; border-radius: 50px; font-size: 20px; 
            font-weight: bold; cursor: pointer; transition: all 0.3s ease; 
            box-shadow: 0 15px 40px rgba(40,167,69,0.4); margin: 20px 0;
        }
        .launch-btn:hover { transform: translateY(-5px); box-shadow: 0 25px 60px rgba(40,167,69,0.6); }
        .launch-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .status { 
            padding: 20px 30px; border-radius: 15px; margin: 20px 0; font-size: 16px; 
            min-height: 80px; display: flex; align-items: center; justify-content: center;
            line-height: 1.5;
        }
        .status.loading { background: rgba(255,255,255,0.1); color: #fff; }
        .status.success { background: rgba(40,167,69,0.3); color: #d4edda; border: 1px solid #28a745; }
        .status.error { background: rgba(220,53,69,0.3); color: #f8d7da; border: 1px solid #dc3545; }
        .info-text { font-size: 14px; opacity: 0.8; margin-top: 30px; }
    </style>
</head>
<body>
    <div class="launch-container">
        <div class="logo">ğŸš¨ Sepsis Monitor</div>
        <h1>æ•—è¡€ç—‡æ—©æœŸç›£æ§ç³»çµ±</h1>
        <p class="subtitle">SMART on FHIR è‡¨åºŠæ±ºç­–æ”¯æ´æ‡‰ç”¨</p>
        
        <div id="status" class="status loading">
            æ­£åœ¨åˆå§‹åŒ– SMART å•Ÿå‹•åºåˆ—...<br>
            <small>è«‹ç¨å€™ï¼Œæ­£åœ¨åµæ¸¬ EHR å•Ÿå‹•åƒæ•¸...</small>
        </div>
        
        <button id="launchBtn" class="launch-btn" style="display: none;" onclick="doLaunch()">
            ğŸš€ å•Ÿå‹•ç³»çµ±
        </button>

        <div class="info-text">
            ç›®æ¨™ä¼ºæœå™¨ï¼šè¡›ç¦éƒ¨ THAS FHIR Server (R4)<br>
            éœ€è¦å¾ EHR ç³»çµ±ï¼ˆå¦‚é†«é™¢è³‡è¨Šç³»çµ±ï¼‰å•Ÿå‹•æ­¤æ‡‰ç”¨
        </div>
    </div>

    <script>
        // SMART Launch é…ç½®
        const config = {
            clientId: "my_sepsis_app",  // è«‹æ›¿æ›æˆä½ åœ¨ THAS è¨»å†Šçš„çœŸå¯¦ client_id
            scope: "patient/Patient.read patient/Observation.read patient/Observation.write patient/Encounter.read openid profile fhirUser",
            redirectUri: window.location.origin + "/index.html",
            iss: null,  // æœƒå¾ URL åƒæ•¸å–å¾—
            launch: null
        };

        let launchDetected = false;

        function updateStatus(message, type = 'loading') {
            const statusEl = document.getElementById('status');
            statusEl.className = `status ${type}`;
            statusEl.innerHTML = message;
        }

        function init() {
            const params = new URLSearchParams(window.location.search);
            
            if (params.has('launch') && params.has('iss')) {
                config.launch = params.get('launch');
                config.iss = params.get('iss');
                
                launchDetected = true;
                updateStatus(
                    `âœ… å·²åµæ¸¬åˆ° EHR å•Ÿå‹•ä¿¡è™Ÿ<br>` +
                    `<small>Issuer: ${config.iss}<br>Launch ID: ${config.launch}</small>`,
                    'success'
                );
                document.getElementById('launchBtn').style.display = 'inline-block';
            } else {
                updateStatus(
                    `âŒ éŒ¯èª¤ï¼šæœªåµæ¸¬åˆ°å¿…è¦çš„å•Ÿå‹•åƒæ•¸ (launch & iss)<br>` +
                    `è«‹å¾ç›¸å®¹çš„ EHR ç³»çµ±ï¼ˆå¦‚ THAS æ•´åˆçš„ HISï¼‰é‡æ–°å•Ÿå‹•æ­¤æ‡‰ç”¨ç¨‹å¼ã€‚<br><br>` +
                    `<small>æç¤ºï¼šç›´æ¥é–‹å•Ÿæ­¤é é¢ç„¡æ³•é€²è¡Œ SMART Launchã€‚</small>`,
                    'error'
                );
            }
        }

        async function doLaunch() {
            const btn = document.getElementById('launchBtn');
            btn.disabled = true;
            btn.textContent = "æ­£åœ¨è·³è½‰æˆæ¬Š...";

            updateStatus("æ­£åœ¨åŸ·è¡Œ SMART æˆæ¬Šæµç¨‹...<br>è«‹å‹¿é—œé–‰è¦–çª—", 'loading');

            try {
                await FHIR.oauth2.authorize({
                    iss: config.iss,
                    clientId: config.clientId,
                    scope: config.scope,
                    redirectUri: config.redirectUri,
                    launch: config.launch,
                    // å¯é¸ï¼šåŠ å…¥ fhirServerï¼ˆå¦‚æœéœ€è¦å¼·åˆ¶æŒ‡å®šï¼‰
                    // fhirServer: "https://thas.mohw.gov.tw/v/r4/fhir"
                });
                // authorize() æœƒè‡ªå‹•é€²è¡Œ redirectï¼Œä¸æœƒåŸ·è¡Œåˆ°é€™è£¡
            } catch (err) {
                console.error("SMART authorize å¤±æ•—", err);
                updateStatus(
                    `âŒ æˆæ¬Šæµç¨‹å•Ÿå‹•å¤±æ•—<br>${err.message || 'æœªçŸ¥éŒ¯èª¤'}<br><br>` +
                    `è«‹é‡æ–°å¾ EHR ç³»çµ±å•Ÿå‹•ï¼Œæˆ–è¯çµ¡ç³»çµ±ç®¡ç†å“¡ç¢ºèª client_id èˆ‡ scopeã€‚`,
                    'error'
                );
                btn.disabled = false;
                btn.textContent = "ğŸš€ å•Ÿå‹•ç³»çµ±";
            }
        }

        // é é¢è¼‰å…¥æ™‚åŸ·è¡Œåˆå§‹åŒ–
        window.onload = init;

        // é˜²æ­¢æ„å¤–é‡æ–°æ•´ç†æ™‚ç‹€æ…‹æ¶ˆå¤±ï¼Œå¯é¸åŠ  localStorage è¨˜éŒ„ï¼ˆä½†é€šå¸¸ä¸éœ€è¦ï¼‰
    </script>
</body>
</html>